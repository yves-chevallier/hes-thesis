%///////////////////////////////////////////////////////////////////////////////
%//  _   _        _                            _                                
%// | | | |      |_|                          | |                               
%// | |_| |_____  _ _____           _     _ __| |                               
%// | |_  | ___ || |  _  \  _____  \ \  / // _  |                               
%// | | | | ____|| | |_| | (_____)  \ \/ /( (_| |                               
%// |_| |_|_____)|_|___  |           \__/  \____|                               
%//                  __| | Haute Ecole d'Ingenieurs                             
%//                 |___/  et de Gestion - Vaud                                 
%//                                                                             
%// @title    Mémoire de diplôme: LonWorks                                      
%// @context  Travail de diplôme                                                
%// @author   Y. Chevallier <nowox@kalios.ch>                                   
%// @file     lonworks.tex                                                      
%// @language ASCII/C                                                           
%// @svn      $Id: lonworks.tex 82 2005-12-14 05:41:51Z Canard $                
%///////////////////////////////////////////////////////////////////////////////
\chapter{LonWorks}
Ce chapitre pourrait faire l'objet d'un ouvrage à lui tout seul. Or, ce qui nous intéresse pour ce travail, ce sont seulement quelques aspects fondamentaux de la technologie. 

\section{Historique}
C'est à la fin des années 80 que LonWorks émerge. Sa grande différence par rapport à beaucoup d'autres bus de terrains c'est qu'il à été conçu par des équipes d'informaticiens et non d'automaticiens ou électroniciens. Se faisant, la technologie fait appel à des concepts informatiques de pointe et les possibilités de LonWorks sont énormes.  

En 1986 Mike Markula, l'un des fondateurs et principal actionnaire d'Apple Computer fonde la société ACM Resarch qui deviendra quelques années plus tard Echelon. Cette nouvelle société propose un nouveau bus de terrain nommé LonWorks (Local Operating Network).  

Au début un seul circuit permettait de dialoguer avec le bus. Il s'agissait d'un ASIC fabriqué par Motorola et Toshiba. Mais très vite, la société Loytec arriva sur le marché avec un tout nouveau chip: le L-chip. Malgré un coût plus élevé que le circuit d'Echelon, le NeuronChip, il s'imposa avec ses possibilités bien plus étendues. 

Aujourd'hui ces deux sociétés détiennent le monopole absolu. L'organisation LonMark à engagé un combat contre ce monopole et vise à rendre la technologie libre. 

Le protocole de communication de LonWorks appelé LonTalk est basé sur les sept couches du modèle OSI. 

\section{LonWorks et OSI}
Le modèle OSI pour \emph{Open Systems Interconnection} à été crée par l'ISO afin d'offrir une base commune à la description de tout bus de communication. Le modèle est décrit en sept couches, chacune apportant un degré d'abstraction supplémentaire concernant l'échange d'information. 

La description des différentes couches concernant LonWorks en partant du principe que nous utilisons un chip de chez Loytec est la suivante :
          
La première décrit la manière dont les informations binaires sont envoyées sur le canal de communication. Il s'agit d'un code de type BIPHASE ou code de MANCHESTER. Cette partie est assumée par le contrôleur hardware. 

La seconde s'occupe de coder l'information la plus efficacement possible pour la transmettre sur le canal. Elle définit la manière dont un élément du réseau accède au canal de communication. Le protocole utilisé est CSMA/CA. ( Vous trouverez dans le glossaire, comme pour tous les autres termes en majuscule de ce document, un lien Internet vers une explication détaillée.)

La troisième (couche de réseau), détermine de quelle manière les paquets sont routés de la source vers les destinataires. Le concept du NEURON ID intervient ici.  C'est un identifiant codé sur 48 bits qui est unique pour chacun des appareils LON. 

La quatrième, (couche de transport) est gérée dans notre application par ORION et n'est pas visible par le programmeur. C'est une librairie logicielle pour les systèmes Microsoft Windows ou Linux, permettant une gestion puissante d'un périphérique LON. C'est à ce niveau que les accusés de réception sont gérés.    

La cinquième, (couche de session) est également gérée par ORION.  Son rôle est de déterminer le type de message reçu ou envoyé : ``Avons-nous reçu une réponse à une demande ou une mise à jour d'une valeur ?'' La librairie Orion transmet à l'utilisateur les informations décodées. Il y a 20 types de messages différents. 

\begin{itemize}
   \item	ORION\_PACKET\_MSG\_OUT
   \item	ORION\_PACKET\_REQ\_OUT
   \item	ORION\_PACKET\_RESP\_OUT
   \item	ORION\_PACKET\_NV\_OUT
   \item	ORION\_PACKET\_NV\_REQ\_OUT
   \item	ORION\_PACKET\_NV\_RESP\_OUT
   \item	ORION\_PACKET\_MSG\_IN
   \item	ORION\_PACKET\_REQ\_IN
   \item	ORION\_PACKET\_RESP\_IN
   \item	ORION\_PACKET\_NV\_IN
   \item	ORION\_PACKET\_NV\_REQ\_IN
   \item	ORION\_PACKET\_RESP\_IN
   \item	ORION\_PACKET\_ONLINE
   \item	ORION\_PACKET\_OFFLINE
   \item	ORION\_PACKET\_RESET
   \item	ORION\_PACKET\_RESET\_FINISHED
   \item	ORION\_PACKET\_WINK
   \item	ORION\_PACKET\_NV\_DEFINE
   \item	ORION\_PACKET\_NV\_REMOVE
   \item	ORION\_PACKET\_UPDATE\_NV\_INFO		
\end{itemize}

La liste ci-dessus n'est citée qu'à titre d'information. La description du code source du démon disponible à l'annexe [refannexe] explique plus en détail chacun de ces messages. 

La sixième  (couche est très intéressante pour ce projet),  décrit une structure élégante pour coder les messages.  Un ensemble d'environ 200 types différents sont définis. Ces structures de données permettent une meilleure interopérabilité entre les différents constructeurs de produits LON. Ce sont les SNVT pour Standard Network Variable Type ou type standard de variable réseau. 	

Pour information, voici quelques SNVT que l'on prononce ``snivit''.

\begin{itemize}
   \item	SNVT switch
   \item	SNVT temp
   \item	SNVT command
   \item	SNVT press
   \item	\ldots
\end{itemize}

\section{Les Variables Standards}
Prenons comme exemple de \emph{SNVT switch}. Il s'agit d'une variable utilisée principalement pour le contrôle d'éclairage. La variable contient deux paramètres. L'un appelé \emph{value} renseigne sur l'intensité lumineuse du périphérique, l'autre, \emph{state} indique l'état binaire du périphérique (i.e. : allumé ou éteint). En terme de programmation C il s'agit d'une structure présentée sous cette forme :

\begin{leftbar}%
\begin{verbatim}
typedef struct  SNVT_switch 
{
	unsigned char state
	unsigned char value
}
\end{verbatim}
\end{leftbar}

Pour une meilleure compréhension de cette description C, l'auteur recommande "L'introduction au langage C" de Bernard Cassagne  [refbib]

Sur LonWorks, l'ensemble des organes du réseau utilise les SNVT. Un périphérique dispose d'un certains nombre de ces variables configurées soit en entrée, soit en sortie. Lors de l'installation du périphérique sur le réseau à l'aide d'un outil de configuration comme NL220 de la société Newron Systems  ce qui permet d'établir ces interconnexions. 

La figure [reffigure] est un exemple d'une installation présentant quelques interconnexions de SNVT. 

Dans le cas de ce projet. Les variables mises à disposition sur le réseau dépendent des interfaces graphiques. Une GI peut présenter cinq contrôles d'éclairage. Ainsi, le SERVEUR devra disposer de cinq SNVT configurées en sortie. La figure [reffigure] illustre mieux ces propos. 

Le fait de devoir disposer d'un nombre de SNVT variable pose un problème avec LonMark. L'organisation établi des standards tels que les SNVT pour assurer une interopérabilité parfaite entre les différents composants de LON.  La représentation [reffigure] démontre, on ne peut mieux, l'importance de l'interopérabilité. 

\section{Le problème des variables dynamiques}
Dans son document ``LonMark Application-Layer Interoperability Guielines'' [bibref], LonMark établi la possibilité de création de SNVT dynamiquement à condition que celle-ci soient crées par un outil de configuration. 

\emph{\small A dynamic network variable is a network variable that is added to a device by a network tool after the device is installed.  A dynamic functional block is a functional block that is added to a device by a network tool after the device is installed}

Cette restriction ne permet pas une totale indépendance du WEBGUI pour la configuration du système. Il est nécessaire de faire appel à un outil de configuration pour gérer les interconnexions entre les variables. 
